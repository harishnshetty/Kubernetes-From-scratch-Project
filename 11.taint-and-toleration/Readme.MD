https://medium.com/@muppedaanvesh/kubernetes-taints-tolerations-b0e0ed076cad

# ğŸ¯ Kubernetes Scheduling â€“ Labels, Affinity & Taints (Complete Guide)

This repository demonstrates **how Kubernetes schedules Pods onto Nodes** using:

* Labels & Selectors
* Node Affinity (required / preferred)
* Pod Affinity & Anti-Affinity
* Taints & Tolerations (`NoSchedule`, `PreferNoSchedule`, `NoExecute`)

---

## ğŸ“š Table of Contents

* Scheduling Basics
* Architecture Diagram
* Labels & Selectors
* Node Affinity
* Preferred vs Required Affinity
* Taints & Tolerations
* NoExecute Taint
* Verification Commands
* Real-World Use Cases
* Production Best Practices

---

## ğŸ§  Kubernetes Scheduling Basics

Kubernetes Scheduler decides **WHERE a Pod runs** based on:

```
Filters (hard rules) â†’ Scoring (soft rules)
```

| Mechanism     | Type             |
| ------------- | ---------------- |
| Labels        | Identification   |
| NodeSelector  | Simple filter    |
| Node Affinity | Advanced filter  |
| Pod Affinity  | Pod-to-Pod rules |
| Taints        | Node repulsion   |
| Tolerations   | Pod permission   |

---

## ğŸ—ï¸ Scheduling Architecture

![Image](https://www.apptio.com/wp-content/uploads/how-node-affinity-works1.png)

![Image](https://trstringer.com/images/prefernoschedule1.excalidraw.png)

```
Pod
 â”‚
 â–¼
Scheduler
 â”‚
 â”œâ”€ Labels / Affinity
 â”œâ”€ Taints / Tolerations
 â”‚
 â–¼
Node
```

---

# ğŸ·ï¸ Labels (`label.yml`)

Labels are **key-value metadata** used for selection.

### Apply label to node

```bash
kubectl label node node1 disktype=ssd
```

### Example Pod using label selector

```yaml
nodeSelector:
  disktype: ssd
```

âœ” Simple
âŒ Limited (exact match only)

---

# ğŸ§² Node Affinity

Node Affinity is the **advanced version of nodeSelector**.

---

## ğŸ”’ Required Node Affinity (`affinity-required.yml`)

> **Hard rule** â€“ Pod will NOT schedule if condition fails

```yaml
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        - key: disktype
          operator: In
          values:
          - ssd
```

ğŸ“Œ Use when:

* GPU nodes
* SSD-only workloads
* Compliance requirements

---

## ğŸ¯ Preferred Node Affinity (`affinity-preferred.yml`)

> **Soft rule** â€“ Scheduler tries but doesnâ€™t force

```yaml
affinity:
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 1
      preference:
        matchExpressions:
        - key: zone
          operator: In
          values:
          - us-east-1a
```

ğŸ“Œ Use when:

* Cost optimization
* Latency preference
* HA setups

---

## âš–ï¸ Required vs Preferred (Critical Difference)

| Feature             | Required | Preferred |
| ------------------- | -------- | --------- |
| Hard rule           | âœ…        | âŒ         |
| Pod stuck pending   | âœ…        | âŒ         |
| Scheduler scoring   | âŒ        | âœ…         |
| Production critical | âœ…        | âš ï¸        |

---

# â˜ ï¸ Taints & Tolerations

Taints **repel Pods** from Nodes.
Tolerations **allow Pods** to be scheduled.

---

## ğŸš« Taint Node

```bash
kubectl taint node node1 key=value:NoSchedule
```

This blocks all Pods **unless tolerated**.

---

## âœ… Toleration (`taint-toleration.yml`)

```yaml
tolerations:
- key: "key"
  operator: "Equal"
  value: "value"
  effect: "NoSchedule"
```

âœ” Pod can now run on tainted node

---

## ğŸ§¨ NoExecute Taint (`noexecute.yml`)

> Strongest taint â€“ **evicts running pods**

```yaml
tolerations:
- key: "maintenance"
  operator: "Exists"
  effect: "NoExecute"
  tolerationSeconds: 30
```

### Behavior

```
No toleration â†’ immediate eviction
With toleration â†’ stays for X seconds
```

ğŸ“Œ Used for:

* Node maintenance
* Spot instance termination
* Node drain automation

---

## â˜ ï¸ Taint Effects (Very Important)

| Effect           | Behavior           |
| ---------------- | ------------------ |
| NoSchedule       | New Pods blocked   |
| PreferNoSchedule | Best-effort        |
| NoExecute        | Evict running Pods |

---

# ğŸ” Verification Commands (SRE Style)

```bash
kubectl get nodes --show-labels
kubectl describe node <node-name>
kubectl get pods -o wide
kubectl describe pod <pod-name>
```

Pending pod debug:

```bash
kubectl get events --sort-by=.metadata.creationTimestamp
```

---

## ğŸŒ Real-World Use Cases

| Scenario       | Solution               |
| -------------- | ---------------------- |
| GPU workloads  | Required Node Affinity |
| Logging agents | Toleration + DaemonSet |
| DB on SSD      | Node labels + affinity |
| Spot nodes     | NoExecute taint        |
| Prod isolation | Taints + tolerations   |

---

## âœ… Production Best Practices

âœ” Use **required affinity** for critical workloads
âœ” Use **preferred affinity** for optimization
âœ” Taint special nodes (GPU, DB, Infra)
âœ” Never rely only on nodeSelector
âœ” Combine with **PodDisruptionBudgets**
âœ” Test failure scenarios

---

## ğŸ§  Interview-Ready One-Liners

* Labels identify, affinity decides
* Required = hard rule, preferred = soft rule
* Taints repel, tolerations allow
* NoExecute evicts running pods
* Scheduler uses filters + scoring

---

