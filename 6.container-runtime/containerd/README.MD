## ğŸ§  What is a Container Runtime?

A **container runtime** is the component responsible for:

* Pulling container images
* Creating containers
* Running containers
* Stopping & deleting containers

ğŸ‘‰ Kubernetes **does NOT run containers directly**
ğŸ‘‰ It talks to the runtime using **CRI (Container Runtime Interface)**

---

## ğŸ—ï¸ Container Runtime Architecture

![Image](https://devoriales.com/static/post_images/high-level-container-architecture.png)

![Image](https://wac-cdn.atlassian.com/dam/jcr%3A8a8c5eff-cedd-4e46-a397-9d635a098afc/Kubernetes-vs-Docker-article_2%402x.jpg?cdnVersion=3145)

```
kubectl
   â”‚
kube-apiserver
   â”‚
kubelet
   â”‚ (CRI)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ containerd   â”‚  â† Runtime
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
     runc
       â”‚
   Linux Kernel
```

---

## ğŸ” Container Runtime Landscape

| Runtime         | Type        | CRI         | Production |
| --------------- | ----------- | ----------- | ---------- |
| Docker          | High-level  | âŒ (removed) | âŒ          |
| containerd      | Low-level   | âœ…           | â­â­â­â­â­      |
| CRI-O           | Low-level   | âœ…           | â­â­â­â­       |
| runc            | OCI runtime | âŒ           | internal   |
| Kata Containers | VM-based    | âœ…           | niche      |

---

# ğŸ³ 1. Docker (âŒ Deprecated in Kubernetes)

### â— Important Truth

* Docker **was removed from Kubernetes v1.24+**
* Kubernetes **never used Docker directly**
* It used **dockershim** (now removed)

```
Kubernetes âŒ Docker
Kubernetes âœ… containerd / CRI-O
```

âœ” Docker still useful for **local development**

---

# ğŸ“¦ 2. containerd (ğŸ”¥ DEFAULT & RECOMMENDED)

### Why containerd?

* CNCF project
* Lightweight
* High performance
* Used by **EKS, GKE, AKS, kubeadm**

---

## ğŸ”§ Install containerd (Ubuntu â€“ Production Way)

### Step 1: Install

```bash
sudo apt update
sudo apt install -y containerd
```

### Step 2: Generate config

```bash
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
```

### Step 3: Enable Systemd Cgroup (MANDATORY)

Edit:

```bash
sudo vi /etc/containerd/config.toml
```

Set:

```toml
SystemdCgroup = true
```

### Step 4: Restart

```bash
sudo systemctl restart containerd
sudo systemctl enable containerd
```

---

## ğŸ” Verify containerd

```bash
crictl info
crictl ps
```

---

## ğŸ“œ Kubernetes Uses containerd Like This

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: runtime-test
spec:
  containers:
  - name: nginx
    image: nginx
```

â¬†ï¸ Kubernetes pulls & runs image via **containerd + runc**

---

# ğŸ”´ 3. CRI-O (RedHat / OpenShift)

### Why CRI-O?

* Built **only for Kubernetes**
* No extra features
* Secure by default

Used by:

* OpenShift
* Some hardened clusters

---

## ğŸ”§ Install CRI-O (Ubuntu Example)

```bash
sudo apt install -y cri-o cri-o-runc
sudo systemctl enable crio
sudo systemctl start crio
```

Verify:

```bash
crictl info
```

---

## ğŸ“œ Pod YAML (Same as containerd)

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: crio-test
spec:
  containers:
  - name: busybox
    image: busybox
    command: ["sleep","3600"]
```

---

# âš™ï¸ 4. runc (Low-Level Runtime)

### What is runc?

* Executes containers
* Implements **OCI spec**
* Used internally by:

  * containerd
  * CRI-O
  * Docker

You **never configure runc directly** in Kubernetes.

---

## ğŸ§  Runtime Relationship (VERY IMPORTANT)

```
Docker
 â””â”€ containerd
     â””â”€ runc

Kubernetes
 â””â”€ containerd / CRI-O
     â””â”€ runc
```

---

# ğŸ§Š 5. Kata Containers (Extra Isolation)

### What makes Kata special?

* Each container runs in a **lightweight VM**
* Strong isolation
* Slight performance overhead

Use cases:

* Multi-tenant clusters
* Untrusted workloads

---

## ğŸ“œ RuntimeClass Example (Kata)

```yaml
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: kata
handler: kata-runtime
```

Pod using Kata:

```yaml
spec:
  runtimeClassName: kata
```

---

# ğŸ” How to Check Runtime in Your Cluster

```bash
kubectl get nodes -o wide
```

Look for:

```
CONTAINER-RUNTIME
containerd://1.7.x
```

Or:

```bash
kubectl describe node | grep -i runtime
```

---

# âš ï¸ Common Runtime Issues (On-Call SRE)

| Issue                           | Cause                     |
| ------------------------------- | ------------------------- |
| Pods stuck in ContainerCreating | Runtime down              |
| CrashLoopBackOff                | Image / runtime error     |
| kubelet not starting            | Cgroup mismatch           |
| ImagePullBackOff                | containerd registry issue |

Fix:

```bash
sudo systemctl restart containerd
journalctl -u containerd
```

---

# ğŸ§­ Runtime Selection Guide

| Environment  | Runtime    |
| ------------ | ---------- |
| kubeadm      | containerd |
| EKS          | containerd |
| GKE          | containerd |
| OpenShift    | CRI-O      |
| Multi-tenant | Kata       |
| Local Dev    | Docker     |

---

## ğŸ§  What is containerd?

`containerd` is a **low-level container runtime** responsible for:

* Pulling container images
* Creating containers
* Running containers
* Managing container lifecycle

ğŸ‘‰ Kubernetes talks to containerd using **CRI (Container Runtime Interface)**
ğŸ‘‰ containerd internally uses **runc** to start containers

---

## ğŸ—ï¸ Container Runtime Architecture

![Image](https://www.simform.com/wp-content/uploads/2023/08/container-runtime-architecture.jpg)

![Image](https://www.ianlewis.org/assets/images/772/CRI.png)

![Image](https://iximiuz.com/containerd-command-line-clients/containerd-command-line-clients-2000-opt.png)

```
kubectl
   â”‚
kube-apiserver
   â”‚
kubelet
   â”‚ (CRI)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ containerd   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ctr / nerdctlâ”‚  â† CLI tools
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
     runc
       â”‚
   Linux Kernel
```

---

## ğŸ“¦ Install containerd (Ubuntu)

### Step 1: Install containerd package

```bash
sudo apt install -y containerd.io
```

---

### Step 2: Create containerd config directory

```bash
sudo mkdir -p /etc/containerd
```

---

### Step 3: Generate default configuration

```bash
sudo containerd config default | sudo tee /etc/containerd/config.toml
```

This creates the **official default runtime configuration**.

---

### Step 4: Restart & enable containerd

```bash
sudo systemctl restart containerd
sudo systemctl enable containerd
```

---

### Step 5: Verify service

```bash
systemctl status containerd
```

---

## ğŸ“¥ Pull Image Using `ctr`

```bash
ctr image pull docker.io/library/alpine:latest
```

### ğŸ” Notes

* `ctr` is **containerdâ€™s native CLI**
* Mostly for **debugging**
* Not user-friendly
* **Not recommended** for daily use

---

## ğŸ§ª Run Container Using `nerdctl`

```bash
nerdctl run -it --rm docker.io/library/alpine:latest
```

### Why nerdctl?

* Docker-like syntax
* Works directly with containerd
* Supports:

  * volumes
  * networks
  * compose

| Tool    | Ease   | Use Case    |
| ------- | ------ | ----------- |
| ctr     | âŒ Hard | Debugging   |
| nerdctl | âœ… Easy | Daily usage |
| docker  | âœ… Easy | Dev only    |

---

## ğŸ” CRI Tool â€“ `crictl`

```bash
crictl
```

### What is `crictl`?

* CLI for **CRI-compatible runtimes**
* Used by Kubernetes admins
* Talks directly to containerd / CRI-O

Common commands:

```bash
crictl info
crictl images
crictl ps
crictl pods
```

---

## ğŸ§  Tool Comparison (Very Important)

| Tool    | Talks To       | Used By           |
| ------- | -------------- | ----------------- |
| ctr     | containerd     | Runtime debugging |
| nerdctl | containerd     | Humans            |
| crictl  | CRI            | Kubernetes admins |
| kubectl | kube-apiserver | Users             |

---

## âš ï¸ Production Best Practices

âœ” Use **containerd**, not Docker
âœ” Use **nerdctl** for local testing
âœ” Use **crictl** for Kubernetes debugging
âœ” Never use `ctr` in automation
âœ” Always enable **systemd cgroups** in `/etc/containerd/config.toml`

---

## ğŸ”§ Mandatory Production Setting (IMPORTANT)

Edit:

```bash
sudo vi /etc/containerd/config.toml
```

Set:

```toml
SystemdCgroup = true
```

Restart:

```bash
sudo systemctl restart containerd
```

Without this â†’ **kubelet will fail**

---

## ğŸ§­ How Kubernetes Uses containerd

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: runtime-test
spec:
  containers:
  - name: alpine
    image: alpine
    command: ["sleep","3600"]
```

Flow:

```
kubectl â†’ kubelet â†’ CRI â†’ containerd â†’ runc â†’ kernel
```

---

## ğŸš¨ Common On-Call Issues

| Issue             | Cause                  |
| ----------------- | ---------------------- |
| ImagePullBackOff  | Registry / auth issue  |
| ContainerCreating | Runtime down           |
| kubelet crash     | Cgroup mismatch        |
| Pods stuck        | containerd not running |

Fix:

```bash
sudo systemctl restart containerd
journalctl -u containerd
```

---

## ğŸ¯ Key Takeaways (Interview Gold)

* Kubernetes **does NOT use Docker**
* containerd is **production standard**
* runc actually **creates containers**
* CRI is the **runtime interface**
* nerdctl = Docker for containerd

---